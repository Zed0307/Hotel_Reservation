<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Moonlight&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: 'Moonlight', cursive;
    background: url("{{ url_for('static', filename='hotel3.jpg') }}") no-repeat center center fixed;
    background-size: cover;
    color: #fff;
  }
  body::before {
    content: "";
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.85);
    z-index:-1;
  }
  .dashboard-header {
    padding: 20px;
    text-align: center;
    background: rgba(0,0,0,0.9);
    box-shadow: 0 0 25px rgba(0,0,0,0.9);
  }
  .dashboard-header h2 {
    margin: 0;
    font-size: 2.5rem;
    color: #FFD700;
    text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700, 0 0 30px #FFA500;
  }
  .dashboard-header a {
    margin-top: 10px;
    display: inline-block;
    padding: 8px 16px;
    background-color: #ff4c4c;
    color: #fff;
    text-decoration: none;
    border-radius: 5px;
    box-shadow: 0 0 10px #ff4c4c, 0 0 20px #ff4c4c;
    transition: 0.3s;
  }
  .dashboard-header a:hover {
    box-shadow: 0 0 15px #ff0000, 0 0 25px #ff0000;
  }
  .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
  .cards-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
  .card-summary {
    flex: 1; min-width: 220px;
    background: rgba(0,0,0,0.95); border-radius: 15px; padding: 20px;
    text-align: center; box-shadow: 0 0 25px rgba(255, 215, 0, 0.6);
    transition: 0.3s;
  }
  .card-summary:hover { box-shadow: 0 0 35px rgba(255, 215, 0, 0.8); }
  .card-summary h3 { margin: 0; font-size: 2rem; color: #FFD700; }
  .card-summary p { margin: 10px 0 0; font-size: 1rem; color: #fff; }

  .card {
    background: rgba(0,0,0,0.95); border-radius: 15px; padding: 20px; margin-bottom: 30px;
    box-shadow: 0 0 25px rgba(255, 215, 0, 0.6); transition: 0.3s;
  }
  .card:hover { box-shadow: 0 0 35px rgba(255, 215, 0, 0.8); }
  .card h5 { margin-bottom: 20px; color: #FFD700; text-shadow: 0 0 5px #FFD700, 0 0 10px #FFA500; }

  table { width: 100%; border-collapse: collapse; color: #fff; }
  table th, table td { padding: 10px; border: 1px solid rgba(255, 215, 0, 0.4); text-align: center; }
  table th { background-color: rgba(255, 215, 0, 0.08); }

  .btn { padding: 5px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-shadow: 0 0 3px #000; transition: 0.3s; }
  .btn-warning { background-color: #FFA500; color: #000; box-shadow: 0 0 5px #FFA500; }
  .btn-warning:hover { box-shadow: 0 0 10px #FFD700; }
  .btn-confirm { background-color:#00cc44; color:#fff; box-shadow:0 0 5px #00cc44; }
  .btn-confirm:hover { box-shadow:0 0 10px #00ff77; }
  .btn-danger { background-color:#ff4c4c; color:#fff; box-shadow:0 0 5px #ff4c4c; }
  .btn-danger:hover { box-shadow:0 0 10px #ff0000; }

  /* ---- cancel-confirmation modal ---- */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.75);
  backdrop-filter: blur(4px);
  z-index: 999;
  display: none;
  align-items: center;
  justify-content: center;
}
.cancel-modal {
  background: linear-gradient(145deg, #1a1a1a, #000);
  border: 2px solid #FFD700;
  border-radius: 20px;
  padding: 35px 45px;
  text-align: center;
  box-shadow: 0 0 30px #FFD700, 0 0 60px rgba(255,215,0,.4);
  max-width: 380px;
  animation: popIn .35s ease-out;
}
@keyframes popIn {
  0%   { transform: scale(.7); opacity: 0; }
  100% { transform: scale(1);   opacity: 1; }
}
.cancel-modal h4 {
  margin: 0 0 12px;
  font-size: 1.6rem;
  color: #FFD700;
  text-shadow: 0 0 8px #FFD700;
}
.cancel-modal p {
  margin: 0 0 25px;
  color: #eee;
  font-size: 1rem;
}
.modal-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
}
.modal-buttons button {
  padding: 10px 25px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: .25s;
}
.btn-confirm-cancel {
  background: #ff4c4c;
  color: #fff;
  box-shadow: 0 0 8px #ff4c4c;
}
.btn-confirm-cancel:hover {
  box-shadow: 0 0 15px #ff0000;
}
.btn-abort {
  background: #444;
  color: #fff;
  box-shadow: 0 0 5px #666;
}
.btn-abort:hover {
  background: #555;
}
</style>
</head>
<body>

<div class="dashboard-header">
  <h2>Admin Dashboard</h2>
  <p>Manage Users, Bookings & Reports</p>
  <a href="{{ url_for('logout') }}">Logout</a>
</div>

<div class="container">

  <!-- Summary Cards -->
  <div class="cards-row">
    <div class="card-summary"><h3>{{ total_users }}</h3><p>Total Users</p></div>
    <div class="card-summary"><h3>{{ total_bookings }}</h3><p>Total Bookings</p></div>
    <div class="card-summary"><h3>{{ total_rooms }}</h3><p>Total Rooms</p></div>
  </div>

  <!-- Users Table (Role removed) -->
  <div class="card">
    <h5>All Users</h5>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Name</th><th>Email</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr id="user-{{ user.id }}">
          <td>{{ user.id }}</td>
          <td>{{ user.name }}</td>
          <td>{{ user.email }}</td>
          <td>
            <button class="btn btn-danger" onclick="deleteUser({{ user.id }})">Delete</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Bookings Table -->
  <div class="card">
    <h5>All Bookings</h5>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>User</th><th>Room Type</th><th>Room #</th>
          <th>Check-In</th><th>Check-Out</th><th>Status</th>
          <th>Payment</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="bookingsTable">
        {% for b in bookings %}
        <tr id="booking-{{ b.booking_id }}">
          <td>{{ b.booking_id }}</td>
          <td>{{ b.user_name }}</td>
          <td>{{ b.room_type }}</td>
          <td>{{ b.room_number }}</td>
          <td>{{ b.check_in }}</td>
          <td>{{ b.check_out }}</td>
          <td id="status-{{ b.booking_id }}">{{ b.status }}</td>
          <td id="payment-{{ b.booking_id }}">
            {% if b.payment_status == 'Paid' %}
              <span style="color:#00cc44;font-weight:bold;">Paid</span>
            {% else %}
              <span style="color:#FFA500;font-weight:bold;">Pending</span>
            {% endif %}
          </td>
          <td>
            {% if b.status != 'Cancelled' %}
              <button class="btn btn-warning" onclick="cancelBooking({{ b.booking_id }})">Cancel</button>
            {% else %}
              <span style="color:#ff4c4c;font-weight:bold;">Cancelled</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
<!-- Recent Admin / Manager Actions -->
<div class="card">
  <h5>Recent Admin / Manager Actions</h5>
  <div style="max-height:300px; overflow-y:auto;">
    <table id="actionsTable">
      <thead>
        <tr>
          <th>Date & Time</th><th>Manager</th><th>Action</th><th>Target</th><th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for a in recent_activities %}
        <tr>
          <td>{{ a.action_time.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>{{ a.manager_name }}</td>
          <td>{{ a.action_type }}</td>
          <td>
            {% if a.booking_id %}
              Booking #{{ a.booking_id }}
            {% elif a.user_id %}
              User #{{ a.user_id }}
            {% else %}
              —
            {% endif %}
          </td>
          <td style="font-size:0.9em;">{{ a.description or '—' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="5" style="text-align:center;color:#aaa;">No actions yet</td></tr>
        {% endfor %}

        <!-- Cancel-confirmation modal -->
<div id="cancelModalOverlay" class="modal-overlay">
  <div class="cancel-modal">
    <h4>Cancel Booking</h4>
    <p id="cancelText">Are you sure you want to cancel this booking?</p>
    <div class="modal-buttons">
      <button class="btn-confirm-cancel" onclick="proceedCancel()">Yes, Cancel</button>
      <button class="btn-abort" onclick="closeCancelModal()">No, Keep It</button>
    </div>
  </div>
</div>
      </tbody>
    </table>
  </div>
</div>


<script>
  /* ---- keep admin-actions table fresh ---- */
setInterval(() => {
  fetch('/admin_get_actions')
    .then(r => r.json())
    .then(data => {
      const tbody = document.querySelector('#actionsTable tbody');
      if (!data.actions) return;
      tbody.innerHTML = data.actions.map(a => `
        <tr>
          <td>${a.action_time}</td>
          <td>${a.manager_name}</td>
          <td>${a.action_type}</td>
          <td>${a.target || '—'}</td>
          <td style="font-size:0.9em;">${a.description || '—'}</td>
        </tr>`).join('');
    })
    .catch(err => console.warn('Actions poll failed:', err));
}, 7000);   // refresh every 7 s
// Delete user
function deleteUser(id){
  if(!confirm("Delete this user?")) return;
  fetch("/admin_delete_user", {
    method: "POST",
    headers: {"Content-Type": "application/x-www-form-urlencoded"},
    body: "user_id=" + id
  })
  .then(r=>r.json())
  .then(res=>{
    alert(res.message);
    if(res.status=="success") document.getElementById("user-"+id).remove();
  });
}

// Cancel booking
let pendingCancelId = null;   // holds booking id while modal is open

function cancelBooking(id){
  pendingCancelId = id;
  document.getElementById('cancelModalOverlay').style.display = 'flex';
}

function closeCancelModal(){
  document.getElementById('cancelModalOverlay').style.display = 'none';
  pendingCancelId = null;
}

function proceedCancel(){
  if (!pendingCancelId) return;
  const id = pendingCancelId;
  closeCancelModal();

  fetch("/admin_cancel_booking", {
      method: "POST",
      headers: {"Content-Type": "application/x-www-form-urlencoded"},
      body: "booking_id=" + id
  })
  .then(r => r.json())
  .then(res => {
      if(res.status === "success"){
          // visual feedback
          const row = document.getElementById(`booking-${id}`);
          row.querySelector(`#status-${id}`).innerText = "Cancelled";
          row.querySelector(`#payment-${id}`).innerHTML =
            '<span style="color:#ff4c4c;font-weight:bold;">Cancelled</span>';
          row.querySelector("td:last-child").innerHTML =
            '<span style="color:#ff4c4c;font-weight:bold;">Cancelled</span>';
          row.style.opacity = "0.6";
      } else {
          alert("Failed: " + res.message);
      }
  })
  .catch(err => alert("Error: " + err));
}

// Mark booking as Paid
function markBookingPaid(booking_id){
    const paymentCell = document.getElementById(`payment-${booking_id}`);
    if(paymentCell){
        paymentCell.innerHTML = '<span style="color:#00cc44;font-weight:bold;">Paid</span>';
    }
}

// Polling every 5 seconds as backup
setInterval(updateBookingsStatus, 5000);
function updateBookingsStatus() {
    fetch("/admin_get_bookings_status")
        .then(res => res.json())
        .then(data => {
            data.bookings.forEach(b => {
                const paymentCell = document.getElementById(`payment-${b.booking_id}`);
                const statusCell = document.getElementById(`status-${b.booking_id}`);
                if(paymentCell){
                    if(b.payment_status === "Paid"){
                        paymentCell.innerHTML = '<span style="color:#00cc44;font-weight:bold;">Paid</span>';
                    } else if(b.status === "Cancelled"){
                        paymentCell.innerHTML = '<span style="color:#ff4c4c;font-weight:bold;">Cancelled</span>';
                    } else {
                        paymentCell.innerHTML = '<span style="color:#FFA500;font-weight:bold;">Pending</span>';
                    }
                }
                if(statusCell) statusCell.innerText = b.status;
            });
        })
        .catch(err => console.error("Error updating bookings:", err));
}

// Listen for instant updates from user payment page
if(window.BroadcastChannel){
    const channel = new BroadcastChannel('booking_updates');
    channel.onmessage = function(event){
        const booking_id = event.data.booking_id;
        markBookingPaid(booking_id);
    };
}
const adminFileForm = document.getElementById('adminFileForm');
const uploadMessage = document.getElementById('uploadMessage');

adminFileForm.addEventListener('submit', function(e){
    e.preventDefault();
    const fileInput = document.getElementById('admin_file');
    const formData = new FormData();
    formData.append('admin_file', fileInput.files[0]);

    fetch('/admin_upload_file', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        uploadMessage.innerText = data.message;
        if(data.status === 'success') {
            uploadMessage.style.color = '#00cc44';
        } else {
            uploadMessage.style.color = '#ff4c4c';
        }
    })
    .catch(err => {
        uploadMessage.innerText = 'Upload failed: ' + err;
        uploadMessage.style.color = '#ff4c4c';
    });
});



</script>

</body>
</html>
