<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Moonlight&display=swap" rel="stylesheet">

<style>
body {
  margin:0;
  font-family:'Moonlight', cursive;
  background:url("{{ url_for('static', filename='hotel3.jpg') }}") no-repeat center center fixed;
  background-size:cover;
  color:#fff;
  text-align:center;
}
body::before {
  content:"";
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.85);
  z-index:-1;
}
h1 {
  font-size:3rem;
  color:#FFD700;
  text-shadow:0 0 10px #FFD700,0 0 20px #FFA500;
  margin-top:30px;
}
.container { max-width:1200px; margin:30px auto; padding:0 20px; }
.card {
  background:rgba(0,0,0,0.95);
  border-radius:15px;
  padding:20px;
  margin-bottom:30px;
  box-shadow:0 0 25px rgba(255,215,0,0.6);
  transition:0.3s;
}
.card:hover { box-shadow:0 0 35px rgba(255,215,0,0.8); }
.card h5 { margin-bottom:20px; color:#FFD700; text-shadow:0 0 5px #FFD700,0 0 10px #FFA500; }
table { width:100%; border-collapse:collapse; color:#fff; }
table th, table td { padding:10px; border:1px solid rgba(255,215,0,0.4); text-align:center; }
table th { background-color: rgba(255,215,0,0.08); }
.btn {
  padding:5px 12px;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-weight:bold;
  text-shadow:0 0 3px #000;
  transition:0.3s;
}
.btn-warning { background-color:#FFA500;color:#000;box-shadow:0 0 5px #FFA500; }
.btn-warning:hover { box-shadow:0 0 10px #FFD700; }
.btn-danger { background-color:#ff4c4c;color:#fff;box-shadow:0 0 5px #ff4c4c; }
.btn-danger:hover { box-shadow:0 0 10px #ff0000; }
.logout {
  margin-bottom:20px;
  padding:10px 25px;
  background:linear-gradient(90deg,#FFD700,#FFA500);
  color:#000;
  font-weight:bold;
  border-radius:8px;
  text-decoration:none;
  box-shadow:0 0 15px #FFD700;
  transition:0.3s;
}
.logout:hover { box-shadow:0 0 25px #FFD700; }

/* Modal */
.modal { display:none; position:fixed; z-index:10; padding-top:100px; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.9); }
.modal-content { background-color:#111; margin:auto; padding:20px; border:1px solid #888; width:400px; border-radius:15px; color:#fff; text-align:left; }
.close { color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
.close:hover, .close:focus { color:#fff; text-decoration:none; cursor:pointer; }
.modal input, .modal select { width:100%; padding:8px; margin:8px 0; border-radius:5px; border:1px solid #ccc; }
.modal button { margin-top:10px; width:100%; }
</style>
</head>
<body>

<h1>Admin Dashboard</h1>
<a href="{{ url_for('logout') }}" class="logout">Logout</a>

<div class="container">

  <!-- Users Section -->
  <div class="card">
    <h5>All Users</h5>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>{{ user.id }}</td>
          <td>{{ user.name }}</td>
          <td>{{ user.email }}</td>
          <td>
            {% if user.role == 1 %}
              Admin
            {% elif user.role == 2 %}
              Manager
            {% else %}
              User
            {% endif %}
          </td>
          <td>
            <button class="btn btn-warning" onclick="openUserEditModal({{ user.id }}, '{{ user.name }}', '{{ user.email }}', '{{ user.role }}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteUser({{ user.id }})">Delete</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Bookings Section -->
  <div class="card">
    <h5>All Bookings</h5>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Room Number</th>
          <th>Room Type</th>
          <th>Check-in</th>
          <th>Check-out</th>
          <th>Status</th>
          <th>Payment</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for booking in bookings %}
        <tr>
          <td>{{ booking.room_id }}</td>
          <td>{{ booking.user_name }}</td>
          <td>{{ booking.number }}</td>
          <td>{{ booking.room_type }}</td>
          <td>{{ booking.check_in }}</td>
          <td>{{ booking.check_out }}</td>
          <td>{{ booking.status | capitalize }}</td>
          <td id="payment-status-{{ booking.room_id }}">
            {{ booking.payment_status | capitalize }}
          </td>
          <td>
            <button class="btn btn-warning"
              onclick="openBookingEditModal({{ booking.room_id }}, {{ booking.number }}, '{{ booking.room_type }}', '{{ booking.check_in }}', '{{ booking.check_out }}')">
              Edit
            </button>
            <button class="btn btn-danger" onclick="cancelBooking({{ booking.room_id }})">Cancel</button>
            {% if booking.payment_status != 'Paid' %}
            <button class="btn btn-warning" onclick="confirmPayment({{ booking.room_id }})">Confirm Payment</button>
            {% else %}
            <button class="btn btn-danger" disabled>Paid</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- Booking Edit Modal -->
<div id="bookingModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeBookingModal()">&times;</span>
    <h3>Edit Booking</h3>
    <form id="bookingEditForm">
      <input type="hidden" name="room_id" id="modalRoomId">
      <label>Room Number</label>
      <input type="number" name="room_number" id="modalRoomNumber" required>
      <label>Room Type</label>
      <select name="room_type" id="modalRoomType" required>
        <option value="Executive">Executive</option>
        <option value="Deluxe">Deluxe</option>
        <option value="Standard">Standard</option>
        <option value="Family">Family</option>
      </select>
      <label>Check-in</label>
      <input type="date" name="check_in" id="modalCheckIn" required>
      <label>Check-out</label>
      <input type="date" name="check_out" id="modalCheckOut" required>
      <button type="button" onclick="submitBookingEdit()">Update Booking</button>
    </form>
  </div>
</div>

<script>
function openBookingEditModal(room_id, number, type, check_in, check_out){
  document.getElementById('modalRoomId').value = room_id;
  document.getElementById('modalRoomNumber').value = number;
  document.getElementById('modalRoomType').value = type;
  document.getElementById('modalCheckIn').value = check_in;
  document.getElementById('modalCheckOut').value = check_out;
  document.getElementById('bookingModal').style.display = "block";
}

function closeBookingModal(){
  document.getElementById('bookingModal').style.display = "none";
}

function submitBookingEdit(){
  const form = document.getElementById('bookingEditForm');
  const data = new URLSearchParams(new FormData(form));

  fetch("/admin_edit_booking", {
    method: "POST",
    body: data
  })
  .then(res => res.json())
  .then(resp => {
    alert(resp.message);
    if(resp.status === "success") location.reload();
  })
  .catch(err => console.error(err));
}

function cancelBooking(room_id){
  if(confirm("Are you sure you want to cancel this booking?")){
    fetch("/manager_cancel_booking", {
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:`booking_id=${room_id}`
    })
    .then(res=>res.json())
    .then(resp=>{ alert(resp.message); location.reload(); });
  }
}

// Confirm payment
function confirmPayment(booking_id) {
    if (!confirm("Are you sure you want to confirm this payment?")) return;

    fetch("/admin_confirm_payment", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `id=${booking_id}`
    })
    .then(res => res.json())
    .then(resp => {
        if (resp.status === "success") {
            const statusCell = document.getElementById(`payment-status-${booking_id}`);
            statusCell.innerText = "Paid";
            showSuccessPrompt(resp.message);
            location.reload();
        } else {
            alert(resp.message);
        }
    })
    .catch(err => console.error(err));
}

// Success prompt
function showSuccessPrompt(message) {
    const prompt = document.getElementById('successPrompt');
    prompt.textContent = message;
    prompt.style.display = 'block';
    setTimeout(() => { prompt.style.display = 'none'; }, 2500);
}
</script>

</body>
</html>
